<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Gradle学习笔记 | demoless.github.io</title><meta name="description" content="Gradle笔记"><meta name="keywords" content="Android,Gradle"><meta name="author" content="zhf"><meta name="copyright" content="zhf"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://yoursite.com/2020/04/09/Gradle学习笔记/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Gradle学习笔记"><meta name="twitter:description" content="Gradle笔记"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/demoless/imgs/note下载.png"><meta property="og:type" content="article"><meta property="og:title" content="Gradle学习笔记"><meta property="og:url" content="http://yoursite.com/2020/04/09/Gradle学习笔记/"><meta property="og:site_name" content="demoless.github.io"><meta property="og:description" content="Gradle笔记"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/demoless/imgs/note下载.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title href="http://yoursite.com/2020/10/27/RecyclerView渲染流程/"><link rel="next" title="Android 事件分发源码解析" href="http://yoursite.com/2019/08/28/Android 事件分发源码解析/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Bookmark',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days'

  
}</script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Gradle基础"><span class="toc-number">1.</span> <span class="toc-text">Gradle基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Groovy语法"><span class="toc-number">1.1.</span> <span class="toc-text">Groovy语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gradle命令行"><span class="toc-number">1.2.</span> <span class="toc-text">Gradle命令行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Projects-和-tasks"><span class="toc-number">1.3.</span> <span class="toc-text">Projects 和 tasks</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Android-Gradle"><span class="toc-number">2.</span> <span class="toc-text">Android Gradle</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#项目build-gradle"><span class="toc-number">2.1.</span> <span class="toc-text">项目build.gradle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模块build-gradle"><span class="toc-number">2.2.</span> <span class="toc-text">模块build.gradle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#全局配置build-gradle"><span class="toc-number">2.3.</span> <span class="toc-text">全局配置build.gradle</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ext块定义属性"><span class="toc-number">2.3.1.</span> <span class="toc-text">ext块定义属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用config-gradle"><span class="toc-number">2.3.2.</span> <span class="toc-text">使用config.gradle</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gradle构建生命周期"><span class="toc-number">2.4.</span> <span class="toc-text">Gradle构建生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#主要生命周期："><span class="toc-number">2.4.1.</span> <span class="toc-text">主要生命周期：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#初始化阶段"><span class="toc-number">2.4.2.</span> <span class="toc-text">初始化阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#settings-gradle"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">settings.gradle</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置阶段"><span class="toc-number">2.4.3.</span> <span class="toc-text">配置阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#执行阶段"><span class="toc-number">2.4.4.</span> <span class="toc-text">执行阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hook-Gradle生命周期"><span class="toc-number">2.4.5.</span> <span class="toc-text">Hook Gradle生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取构建耗时"><span class="toc-number">2.4.6.</span> <span class="toc-text">获取构建耗时</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Project"><span class="toc-number">3.</span> <span class="toc-text">Project</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#API介绍"><span class="toc-number">3.1.</span> <span class="toc-text">API介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#核心API"><span class="toc-number">3.2.</span> <span class="toc-text">核心API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#getAllprojects"><span class="toc-number">3.2.1.</span> <span class="toc-text">getAllprojects</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getSubprojects"><span class="toc-number">3.2.2.</span> <span class="toc-text">getSubprojects</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getParent"><span class="toc-number">3.2.3.</span> <span class="toc-text">getParent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getRootProject"><span class="toc-number">3.2.4.</span> <span class="toc-text">getRootProject</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#project"><span class="toc-number">3.2.5.</span> <span class="toc-text">project</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#subprojects"><span class="toc-number">3.2.6.</span> <span class="toc-text">subprojects</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件API"><span class="toc-number">3.3.</span> <span class="toc-text">文件API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#路径获取API"><span class="toc-number">3.3.1.</span> <span class="toc-text">路径获取API</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Task"><span class="toc-number">4.</span> <span class="toc-text">Task</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Task依赖和执行顺序"><span class="toc-number">4.1.</span> <span class="toc-text">Task依赖和执行顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#dependsOn-强依赖"><span class="toc-number">4.1.1.</span> <span class="toc-text">dependsOn 强依赖</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过-Task-指定输入输出"><span class="toc-number">4.2.</span> <span class="toc-text">通过 Task 指定输入输出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gradle原理"><span class="toc-number">5.</span> <span class="toc-text">Gradle原理</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/demoless/imgs/note下载.png)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">demoless.github.io</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description"></div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Gradle学习笔记</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-04-09<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-06-22</time><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">4.6k</span><span class="post-meta__separator">|</span><span>Reading time: 17 min</span><span class="post-meta__separator">|</span><span>Post View: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h2 id="Gradle基础"><a href="#Gradle基础" class="headerlink" title="Gradle基础"></a>Gradle基础</h2><h3 id="Groovy语法"><a href="#Groovy语法" class="headerlink" title="Groovy语法"></a>Groovy语法</h3><ul>
<li>类型定义</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> vs = <span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> version = <span class="string">'version1'</span><span class="comment">//定义一个字符串</span></span><br><span class="line"><span class="keyword">def</span> s2 = <span class="string">"version is $&#123;version&#125;"</span></span><br><span class="line"><span class="keyword">def</span> map = [<span class="string">"key"</span>:<span class="string">"test"</span>,<span class="string">"value"</span>:<span class="string">"gradle"</span>,<span class="string">"version"</span>:<span class="number">5.6</span>]</span><br><span class="line">println(vs)<span class="comment">//输出打印</span></span><br><span class="line">println version<span class="comment">//括号可以省略</span></span><br></pre></td></tr></table></figure>

<ul>
<li>方法</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task invokeMethod &lt;&lt; &#123;<span class="comment">//这里的&lt;&lt;相当于dolast 最后执行</span></span><br><span class="line">  method(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">  method <span class="number">1</span>,<span class="number">2</span><span class="comment">//括号可以省略 更简洁 在gradle中较常见</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">def</span> method(<span class="keyword">int</span> a,<span class="keyword">int</span> b) &#123;</span><br><span class="line">  println a+b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>闭包</li>
</ul>
<p>闭包简单说就是代码块，如下：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> v = &#123;</span><br><span class="line">    v -&gt; println v</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">def</span> testMethod(Closure closure)&#123;</span><br><span class="line">    closure(<span class="string">'闭包 test'</span>)</span><br><span class="line">&#125;</span><br><span class="line">testMethod v</span><br></pre></td></tr></table></figure>

<p>其中定义的v就为闭包，testMethod 为一个方法，传入参数Closure为闭包，然后调用闭包。</p>
<p>闭包可以作为参数传递，以集合的each方法为例：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">list.each(&#123;println it&#125;)<span class="comment">//传统的参数传递写法大概如此</span></span><br><span class="line"><span class="comment">//groovy支持当最后一个参数是闭包的时候 可以放到方法外面去</span></span><br><span class="line">list.each()&#123;</span><br><span class="line">  println it<span class="comment">//这样看是不是感觉很像java的方法调用 看着比较简洁</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//方法的括号可以省略 就成了gradle里常见的样式</span></span><br><span class="line">list.each&#123;</span><br><span class="line">  println it<span class="comment">//这里的it和kotlin里let等操作符的it类似</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>向闭包传递参数</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task helloClosure &lt;&lt; &#123;</span><br><span class="line">  eachMap&#123;k,v-&gt;</span><br><span class="line">    println <span class="string">"$&#123;k&#125; is $&#123;v&#125;"</span><span class="comment">//调用eachMap方法 并在闭包中显式声明参数</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">def</span> eachMap(Closure closure)&#123;</span><br><span class="line">  <span class="keyword">def</span> map = [<span class="string">"name"</span>:<span class="string">"zhf"</span>,<span class="string">"age"</span>:<span class="string">"21"</span>]</span><br><span class="line">  map.each&#123;</span><br><span class="line">    closure(it.key,it.value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>闭包委托</li>
</ul>
<p>Groovy支持闭包方法的委托。有三种委托分别是：</p>
<pre><code>1. thisObject
 2. owner
 3. delegate</code></pre><p>其中默认情况下owner和delegate的作用相同，但delegate可以更改。thisObject和this对象也是相等的。由于优先级的不同。三种委托的执行顺序是：thisObject -&gt; owner -&gt; delegate</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task configClosure &lt;&lt; &#123;</span><br><span class="line">  person &#123;</span><br><span class="line">    name = <span class="string">"zhf"</span></span><br><span class="line">    age = <span class="number">21</span></span><br><span class="line">    printlnPerson()<span class="comment">//显然这里会输出咱们上面配置的信息</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> person(Closure&lt;Person&gt; closure)&#123;</span><br><span class="line">  Person P = <span class="keyword">new</span> Person()</span><br><span class="line">  closure.delegate = P</span><br><span class="line">  <span class="comment">//委托模式优先</span></span><br><span class="line">  closure.setResolveStrategy(Closure&gt;DELEGATE_FIRST)</span><br><span class="line">  closure(P)</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>&#123;</span></span><br><span class="line">	String name</span><br><span class="line">	<span class="keyword">int</span> age</span><br><span class="line">  <span class="keyword">def</span> printlnPserson()&#123;</span><br><span class="line">    println <span class="string">"name is $&#123;name&#125;,age is $&#123;age&#125;"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的了例子中我们设置了代理对象为当前创建的实例，并且设置了委托模式优先，所以我们在使用person方法创建一个person实例的时候，可以直接对该Person对象进行配置。在Gradle中还有很多类似的用法，基本上都是使用delegate来进行配置等操作</p>
<h3 id="Gradle命令行"><a href="#Gradle命令行" class="headerlink" title="Gradle命令行"></a>Gradle命令行</h3><ul>
<li>-i:Gradle默认不会输出很多信息，你可以使用-i选项改变日志级别为INFO </li>
<li>-s:如果运行时错误发生打印堆栈信息 </li>
<li>-q:只打印错误信息 使用命令行 </li>
<li>-?-h,–help:打印所有的命令行选项 </li>
<li>-b,–build-file:Gradle默认执行build.gradle脚本，如果想执行其他脚本可以使用这个命令，比如gradle -b test.gradle –offline:在离线模式运行build,Gradle只检查本地缓存中的依赖</li>
<li>-D, –system-prop:Gradle作为JVM进程运行，你可以提供一个系统属性比如：- Dmyprop=myValue </li>
<li>-P,–project-prop:项目属性可以作为你构建脚本的一个变量，你可以传递一个属性值给 build脚本，比如：-Pmyprop=myValue</li>
<li>tasks:显示项目中所有可运行的任务 </li>
<li>properties:打印你项目中所有的属性值</li>
</ul>
<h3 id="Projects-和-tasks"><a href="#Projects-和-tasks" class="headerlink" title="Projects 和 tasks"></a>Projects 和 tasks</h3><ul>
<li>Task依赖</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task dependsOnTesk &#123;</span><br><span class="line">  dependsOn tesk1,tesk2</span><br><span class="line">  doLast &#123;</span><br><span class="line">    println <span class="string">"dependsOn"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>自定义属性</li>
</ul>
<p>Project和Task都支持自定义属性，通过ext属性来完成添加和读取</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">//自定义一个project属性</span></span><br><span class="line">ext.age = <span class="number">18</span></span><br><span class="line"><span class="comment">//通过代码块完成自定义多个属性</span></span><br><span class="line">ext&#123;</span><br><span class="line">  phone = <span class="number">1234567</span></span><br><span class="line">  address = <span class="string">"www.test.com"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>任务之间通过依赖来控制任务的执行时序，在创建task 的时候通过dependsOn可以指定其依赖的任务</p>
<h2 id="Android-Gradle"><a href="#Android-Gradle" class="headerlink" title="Android Gradle"></a>Android Gradle</h2><p>下图是一个名为ImageViewShow的Android工程结构图，包含两个module和Gradle相关文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/demoless/imgs/noteimage-20200409150505394.png" alt="image-20200409150505394"></p>
<p>gralde的项目配置是先识别 settings.gradle，然后在配置各个build.gradle。一个Android工程的Gradle包含如下内容（按上图顺序介绍）：</p>
<ul>
<li>根项目的builde.gradle文件 配置项目的整体属性，比如指定使用的代码仓库、依赖的Gradle插件版本等等。</li>
<li>子module的build.gradle文件 配置当前Module的编译参数 此处对应有app和test的两个module</li>
<li>Gradle Version的配置文件</li>
<li>子module的规则配置文件</li>
<li>根project的properties文件 配置Gradle的编译参数</li>
<li>根project的Setting文件 配置Gradle的多项目管理</li>
<li>一般用来存放该Android项目的私有属性配置，比如Android项目的SDK路径</li>
</ul>
<p>现在来验证一下gradle文件的配置顺序，在setting和build文件里添加一句输出语句：println “···”，使用./graldew命令运行：</p>
<p><img src="https://cdn.jsdelivr.net/gh/demoless/imgs/noteimage-20200409152533317.png" alt="image-20200409152533317"></p>
<p>显然，gradle的执行顺序按照setting -&gt; project build.gradle -&gt; project.app build.gradle -&gt; project.test build.gradle 的顺序来执行的</p>
<h3 id="项目build-gradle"><a href="#项目build-gradle" class="headerlink" title="项目build.gradle"></a>项目build.gradle</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span></span><br><span class="line">println <span class="string">"root build.gradle"</span></span><br><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">'com.android.tools.build:gradle:3.6.1'</span></span><br><span class="line">        <span class="comment">//配置依赖的Gradle插件版本，Gradle插件属于第三方插件，因此这里在buildscrip块中配置谷歌的Maven库和JCenter库，这样Gradle系统才能找到对应的Gradle插件</span></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task clean(<span class="string">type:</span> Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="模块build-gradle"><a href="#模块build-gradle" class="headerlink" title="模块build.gradle"></a>模块build.gradle</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">println <span class="string">"app build.gradle"</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span><span class="comment">//应用为gradle插件类型</span></span><br><span class="line"><span class="comment">//用于描述该Module构建过程中所用到的所有参数</span></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">29</span><span class="comment">//配置编译该模块的SDK版本</span></span><br><span class="line">    buildToolsVersion <span class="string">"29.0.2"</span><span class="comment">//Android构建工具的版本</span></span><br><span class="line">  	<span class="comment">//defaultConfig块用于默认配置</span></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">"com.example.imageviewshow"</span><span class="comment">//App包名</span></span><br><span class="line">        minSdkVersion <span class="number">21</span><span class="comment">//App支持的最低SDK版本</span></span><br><span class="line">        targetSdkVersion <span class="number">29</span><span class="comment">//工程开发使用版本</span></span><br><span class="line">        versionCode <span class="number">1</span><span class="comment">//版本号 用于控制App升级</span></span><br><span class="line">        versionName <span class="string">"1.0"</span><span class="comment">//App版本名称 就是发布的版本号</span></span><br><span class="line">        testInstrumentationRunner <span class="string">"androidx.test.runner.AndroidJUnitRunner"</span><span class="comment">//默认使用的单元测试的Runner</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//用于配置构建APK的类型 默认类型有release和debug</span></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android-optimize.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">//用于配置签名设置，一般用来配置release模式</span></span><br><span class="line">  	signingConfigs &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            storeFile file(<span class="string">'/Users/zhangfan/StudioProjects/.android/release.keystore'</span>)</span><br><span class="line">            storePassword <span class="string">'android'</span></span><br><span class="line">            keyAlias <span class="string">'androidreleasekey'</span></span><br><span class="line">            keyPassword <span class="string">'android'</span></span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        sourceCompatibility = <span class="number">1.8</span></span><br><span class="line">        targetCompatibility = <span class="number">1.8</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//用于配置该module构建过程中所依赖的所有库</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation fileTree(<span class="string">dir:</span> <span class="string">'libs'</span>, <span class="string">include:</span> [<span class="string">'*.jar'</span>])</span><br><span class="line">    implementation <span class="string">'androidx.appcompat:appcompat:1.0.2'</span></span><br><span class="line">    implementation <span class="string">'androidx.constraintlayout:constraintlayout:1.1.3'</span></span><br><span class="line">    implementation <span class="string">'androidx.recyclerview:recyclerview:1.1.0'</span></span><br><span class="line">    implementation <span class="string">'com.squareup.okhttp3:logging-interceptor:4.3.0'</span></span><br><span class="line">    implementation <span class="string">'com.squareup.retrofit2:adapter-rxjava2:2.7.1'</span></span><br><span class="line">    implementation <span class="string">'com.squareup.retrofit2:converter-gson:2.7.1'</span></span><br><span class="line">    implementation <span class="string">'io.reactivex.rxjava2:rxandroid:2.0.2'</span></span><br><span class="line">    implementation <span class="string">'androidx.viewpager2:viewpager2:1.0.0-alpha01'</span></span><br><span class="line">    implementation <span class="string">'com.facebook.fresco:fresco:2.1.0'</span></span><br><span class="line">    implementation <span class="string">'com.squareup.retrofit2:retrofit:2.7.1'</span></span><br><span class="line">    implementation <span class="string">"io.reactivex.rxjava2:rxjava:2.2.17"</span></span><br><span class="line">    implementation <span class="string">'androidx.legacy:legacy-support-v4:1.0.0'</span></span><br><span class="line">    testImplementation <span class="string">'junit:junit:4.12'</span></span><br><span class="line">    androidTestImplementation <span class="string">'androidx.test.ext:junit:1.1.0'</span></span><br><span class="line">    androidTestImplementation <span class="string">'androidx.test.espresso:espresso-core:3.1.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Gradle的Android插件类型</li>
</ul>
<p>apply引入的插件id为com.android.application，说明当前模块是一个应用程序模块，Gradle的Android插件有多个类型分别为：</p>
<blockquote>
<ol>
<li>应用程序插件，插件id为com.android.application，会生成一个APK。</li>
<li>库插件，插件id为com.android.library，会生成一个AAR，提供给其他应用程序模块用。</li>
<li>测试插件，插件id为com.android.test，用于测试其他的模块。</li>
<li>feature插件，插件id为com.android.feature，创建Android Instant App时需要用到的插件。</li>
<li>Instant App插件，插件id为com.android.instantapp，是Android Instant App的入口</li>
</ol>
</blockquote>
<ul>
<li>defaultConfig 常用配置补充</li>
</ul>
<blockquote>
<ol>
<li>proguardFile 代码混淆使用的配置文件</li>
<li>proguardFiles 配置的多个ProGuard文件</li>
<li>signingConfig 配置默认的签名信息 </li>
</ol>
</blockquote>
<ul>
<li>buildTypes</li>
</ul>
<table>
<thead>
<tr>
<th>applicationIdSuffix</th>
<th align="center">配置applicationId的后缀</th>
</tr>
</thead>
<tbody><tr>
<td>debuggable</td>
<td align="center">表示是否支持断点调试</td>
</tr>
<tr>
<td>jniDebuggable</td>
<td align="center">表示是否可以调试NDK代码</td>
</tr>
<tr>
<td>buildConfigField</td>
<td align="center">配置不同的开发环境，比如测试环境和正式环境</td>
</tr>
<tr>
<td>shrinkResources</td>
<td align="center">是否自动清理未使用的资源，默认值为false</td>
</tr>
<tr>
<td>zipAlignEnabled</td>
<td align="center">是否开启开启zipalign优化，提高apk运行效率</td>
</tr>
<tr>
<td>proguardFile</td>
<td align="center">ProGuard混淆所使用的ProGuard配置文件</td>
</tr>
<tr>
<td>proguardFiles</td>
<td align="center">同事配置多个ProGuard配置文件</td>
</tr>
<tr>
<td>signingConfig</td>
<td align="center">配置默认的签名信息</td>
</tr>
<tr>
<td>multiDexEnabled</td>
<td align="center">是否启用自动拆分多个Dex的功能</td>
</tr>
</tbody></table>
<ul>
<li>其他配置</li>
</ul>
<h3 id="全局配置build-gradle"><a href="#全局配置build-gradle" class="headerlink" title="全局配置build.gradle"></a>全局配置build.gradle</h3><p>如果有多个module的配置是一样的，可以将这些配置提取出来，也就是使用全局配置。全局配置有多种方式，这里介绍其中的两种</p>
<h4 id="ext块定义属性"><a href="#ext块定义属性" class="headerlink" title="ext块定义属性"></a>ext块定义属性</h4><p>在项目build.gradle中使用ext块，如下所示:</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">ext&#123;</span><br><span class="line">  compileSdkVersion =<span class="number">29</span></span><br><span class="line">  buildToolVersion =<span class="string">"29.0.2"</span></span><br><span class="line">  applicationId <span class="string">"com.example.imageviewshow"</span></span><br><span class="line">  minSdkVersion <span class="number">21</span></span><br><span class="line">  targetSdkVersion <span class="number">29</span></span><br><span class="line">  versionCode <span class="number">1</span></span><br><span class="line">  versionName <span class="string">"1.0"</span></span><br><span class="line">  testInstrumentationRunner <span class="string">"androidx.test.runner.AndroidJUnitRunner"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在某个module的build.gradle中使用配置：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion rootProject.ext.compileSdkVersion</span><br><span class="line">    buildToolsVersion rootProject.ext.buildToolsVersion</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId rootProject.ext.applicationId</span><br><span class="line">        minSdkVersion rootProject.ext.minSdkVersion</span><br><span class="line">        targetSdkVersion rootProject.ext.targetSdkVersion</span><br><span class="line">      	···</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这里利用的是上面介绍过的ext自定义属性来实现的，但是如果都把ext代码块写在项目根build.gradle文件里，那会十分臃肿难以维护，所以另一种方式就是将这里ext代码块写在单独的文件里，使用时引入这个文件就好了。</p>
<h4 id="使用config-gradle"><a href="#使用config-gradle" class="headerlink" title="使用config.gradle"></a>使用config.gradle</h4><ol>
<li>在项目根目录下创建config.gradle文件：</li>
</ol>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">ext&#123;</span><br><span class="line">  android=[</span><br><span class="line">    compileSdkVersion =<span class="number">29</span></span><br><span class="line">  	buildToolVersion =<span class="string">"29.0.2"</span></span><br><span class="line">  	applicationId <span class="string">"com.example.imageviewshow"</span></span><br><span class="line">  	minSdkVersion <span class="number">21</span></span><br><span class="line">  	targetSdkVersion <span class="number">29</span></span><br><span class="line">  	versionCode <span class="number">1</span></span><br><span class="line">  	versionName <span class="string">"1.0"</span></span><br><span class="line">	  testInstrumentationRunner <span class="string">"androidx.test.runner.AndroidJUnitRunner"</span></span><br><span class="line">  ]</span><br><span class="line">  dependencies =[</span><br><span class="line">      ···</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在根项目build.gradle文件里使用**apply from: “config.gradle”,这样项目所有module都能使用config.gradle的参数</li>
<li>最后在module里使用,使用方式与上一种方式相同</li>
</ol>
<h3 id="Gradle构建生命周期"><a href="#Gradle构建生命周期" class="headerlink" title="Gradle构建生命周期"></a>Gradle构建生命周期</h3><h4 id="主要生命周期："><a href="#主要生命周期：" class="headerlink" title="主要生命周期："></a>主要生命周期：</h4><ul>
<li><p>初始化阶段：负责判断有多少个Projects参与构建</p>
</li>
<li><p>配置阶段：负责对初始化阶段创建的Projects完成配置</p>
</li>
<li><p>执行阶段：根据配置阶段的配置执行任务</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doBuildStages</span><span class="params">(Stage upTo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//编译buildSrc 、load settings.gradle</span></span><br><span class="line">        loadSettings();</span><br><span class="line">        <span class="comment">//配置project</span></span><br><span class="line">        configureBuild();</span><br><span class="line">        <span class="comment">//构建task图</span></span><br><span class="line">        constructTaskGraph();</span><br><span class="line">        <span class="comment">//执行task</span></span><br><span class="line">        runTasks();</span><br><span class="line">        <span class="comment">//build结束</span></span><br><span class="line">        finishBuild();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="初始化阶段"><a href="#初始化阶段" class="headerlink" title="初始化阶段"></a>初始化阶段</h4><p>这个阶段中，会读取根工程中的 setting.gradle 中的 include 信息，确定有多少工程加入构建，然后，<strong>会为每一个项目（build.gradle 脚本文件）创建一个个与之对应的 Project 实例，最终形成一个项目的层次结构</strong>。 与初始化阶段相关的脚本文件是 <strong>settings.gradle</strong>，而一个 <strong>settings.gradle</strong> 脚本对应一个 <strong>Settings</strong> 对象，我们最常用来声明项目的层次结构的 <strong>include</strong> 就是 <strong>Settings</strong> 对象下的一个方法，<strong>在 Gradle 初始化的时候会构造一个 Settings 实例对象，以执行各个 Project 的初始化配置</strong></p>
<h5 id="settings-gradle"><a href="#settings-gradle" class="headerlink" title="settings.gradle"></a>settings.gradle</h5><p>在 <strong>settings.gradle</strong> 文件中，我们可以 <strong>在 Gradle 的构建过程中添加各个生命周期节点监听</strong>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/demoless/imgs/noteimage-20200426184555222.png" alt="image-20200426184555222"></p>
<h4 id="配置阶段"><a href="#配置阶段" class="headerlink" title="配置阶段"></a>配置阶段</h4><p>配置阶段的任务是 <strong>执行各项目下的 build.gradle 脚本，完成 Project 的配置，与此同时，会构造 Task 任务依赖关系图以便在执行阶段按照依赖关系执行 Task</strong>。而在配置阶段执行的代码通常来说都会包括以下三个部分的内容：</p>
<ul>
<li>build.gradle</li>
<li>闭包</li>
<li>Task中的配置段语句</li>
</ul>
<blockquote>
<p>任何Gradle命令被执行 初始化和配置阶段的代码都会被执行</p>
</blockquote>
<h4 id="执行阶段"><a href="#执行阶段" class="headerlink" title="执行阶段"></a>执行阶段</h4><p>配置阶段结束后，Gradle 会根据各个任务 Task 的依赖关系来创建一个有向无环图，我们可以通过 Gradle 对象的 getTaskGraph 方法来得到该有向无环图 =&gt; TaskExecutionGraph，并且，当有向无环图构建完成之后，所有 Task 执行之前，我们可以通过 whenReady(groovy.lang.Closure) 或者 addTaskExecutionGraphListener(TaskExecutionGraphListener) 来接收相应的通知：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">gradle.getTaskGraph().addTaskExecutionGraphListener(newTaskExecutionGraphListener()&#123;    </span><br><span class="line">  <span class="meta">@Override</span>    </span><br><span class="line">  <span class="keyword">void</span> graphPopulated(TaskExecutionGraph graph) &#123;  </span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Hook-Gradle生命周期"><a href="#Hook-Gradle生命周期" class="headerlink" title="Hook Gradle生命周期"></a>Hook Gradle生命周期</h4><p> 整个 Gradle 生命周期的流程包含如下 <strong>四个部分</strong>：</p>
<ul>
<li><strong>解析 settings.gradle 来获取模块信息，这是初始化阶段</strong>。</li>
<li><strong>配置每个模块，配置的时候并不会执行 task</strong>。</li>
<li><strong>配置完了以后，有一个重要的回调 project.afterEvaluate，它表示所有的模块都已经配置完了，可以准备执行 task 了</strong>。</li>
<li><strong>执行指定的 task 及其依赖的 task</strong></li>
</ul>
<p>Hook注意点：</p>
<blockquote>
<p><strong>Hook 点对应的监听器一定要在回调的生命周期之前添加</strong></p>
<p><strong>注册了多个 project.afterEvaluate 回调，那么执行顺序将与注册顺序保持一致</strong></p>
</blockquote>
<h4 id="获取构建耗时"><a href="#获取构建耗时" class="headerlink" title="获取构建耗时"></a>获取构建耗时</h4><p>在setting.gradle中加入：</p>
<p><img src="https://cdn.jsdelivr.net/gh/demoless/imgs/noteimage-20200426201904356.png" alt="image-20200426201904356"></p>
<p>Gradle 中，执行每一种类型的配置脚本就会创建与之对应的实例，而在 Gradle 中如 <strong>三种类型的配置脚本</strong>，如下所示：</p>
<ul>
<li><code>Init Scrpit</code>：<strong>对应一个 Gradle 实例，它在构建初始化时创建，整个构建执行过程中以单例形式存在</strong></li>
<li><code>Build Scrpit</code>：<strong>对应一个 Project 实例，即每个 build.gradle 都会转换成一个 Project 实例</strong>。</li>
<li>Settings Scrpit`：<strong>对应一个 Settings 实例，即每个 settings.gradle 都会转换成一个 Settings 实例</strong>。</li>
</ul>
<p>一个 Gradle 构建流程中会由一至多个 project 实例构成，而每一个 project 实例又是由一至多个 task 构成。</p>
<h2 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h2><p>Project 是 Gradle 构建整个应用程序的入口，所以它非常重要。每一个 build.gradle 都有一个与之对应的 Project 实例，而在 build.gradle 中，我们通常都会配置一系列的项目依赖，比如第三方库Glide：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">implementation <span class="string">'com.github.bumptech.glide:glide:4.8.0'</span></span><br></pre></td></tr></table></figure>

<p>类似于 implementation、api 这种依赖关键字，在本质上它就是一个方法调用，在上面，我们使用 implementation() 方法传入了一个 map 参数，参数里面有三对 key-value，完整写法如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">implementation group: <span class="string">'com.github.bumptech.glide'</span> name:<span class="string">'glide'</span> version:<span class="string">'4.8.0'</span></span><br></pre></td></tr></table></figure>

<p><strong>当我们使用 implementation、api 依赖对应的 aar 文件时，Gradle 会在 repository 仓库 里面找到与之对应的依赖文件，你的仓库中可能包含 jcenter、maven 等一系列仓库，而每一个仓库其实就是很多依赖文件的集合服务器, 而他们就是通过上述的 group、name、version 来进行归类存储的</strong></p>
<h3 id="API介绍"><a href="#API介绍" class="headerlink" title="API介绍"></a>API介绍</h3><p>Project 中有很多的 API，根据它们的 <strong>属性和用途</strong> 我们可以将其分解为 <strong>六大部分</strong>：</p>
<p>![Project API](<a href="https://cdn.jsdelivr.net/gh/demoless/imgs/noteProject" target="_blank" rel="noopener">https://cdn.jsdelivr.net/gh/demoless/imgs/noteProject</a> API.png)</p>
<p>1）、<code>Project API</code>：<strong>让当前的 Project 拥有了操作它的父 Project 以及管理它的子 Project 的能力</strong></p>
<p>2）、<code>Task 相关 API</code>：<strong>为当前 Project 提供了新增 Task 以及管理已有 Task 的能力。由于 task 非常重要，我们将放到第四章来进行讲解</strong></p>
<p>3）、<code>Project 属性相关的 Api</code>：<strong>Gradle 会预先为我们提供一些 Project 属性，而属性相关的 api 让我们拥有了为 Project 添加额外属性的能力</strong></p>
<p>4）、<code>File 相关 Api</code>：<strong>Project File 相关的 API 主要用来操作我们当前 Project 下的一些文件处理</strong></p>
<p>5）、<code>Gradle 生命周期 API</code>：<strong>即我们在第二章讲解过的生命周期 API</strong></p>
<p>6）、<code>其它 API</code>：<strong>添加依赖、添加配置、引入外部文件等等零散 API 的聚合</strong></p>
<h3 id="核心API"><a href="#核心API" class="headerlink" title="核心API"></a>核心API</h3><p><strong>每一个 Groovy 脚本都会被编译器编译成 Script 字节码，而每一个 build.gradle 脚本都会被编译器编译成 Project 字节码，所以我们在 build.gradle 中所写的一切逻辑都是在 Project 类内进行书写的</strong></p>
<h4 id="getAllprojects"><a href="#getAllprojects" class="headerlink" title="getAllprojects"></a>getAllprojects</h4><p>build.gradle文件中获取所有project实例：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.getProjects()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> getProjects() &#123;</span><br><span class="line">    println <span class="string">"&lt;==========================&gt;"</span></span><br><span class="line">    println <span class="string">"Root Project Start"</span></span><br><span class="line">    println <span class="string">"&lt;==========================&gt;"</span></span><br><span class="line">    <span class="comment">//getAllProjects 返回一个包含所有Project(根Project和子Project的Set集合)</span></span><br><span class="line">    <span class="comment">//eachWithIndex 遍历集合、数组等可迭代的容器并返回下标 each方法仅返回project</span></span><br><span class="line">    <span class="keyword">this</span>.getAllprojects().eachWithIndex &#123; Project project, <span class="keyword">int</span> index -&gt;</span><br><span class="line">        <span class="comment">//rootProject下标为0</span></span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">            println <span class="string">"Root Project is $project"</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            println <span class="string">"child Project is $project"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行<strong>./gradlew clean</strong>命令，运行结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/demoless/imgs/noteimage-20200426205023734.png" alt="image-20200426205023734"></p>
<p><strong>rootProject 与各个子工程组成了一个树形结构，但是这颗树的高度也仅仅被限定为了两层</strong></p>
<h4 id="getSubprojects"><a href="#getSubprojects" class="headerlink" title="getSubprojects"></a>getSubprojects</h4><p>getSubProjects用于获取工程下所有子工程的实例：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.getSubProjects()</span><br><span class="line"><span class="keyword">def</span> getSubProjects() &#123;</span><br><span class="line">    println <span class="string">"&lt;==========================&gt;"</span></span><br><span class="line">    println <span class="string">"Sub Project Start"</span></span><br><span class="line">    println <span class="string">"&lt;==========================&gt;"</span></span><br><span class="line">  	<span class="comment">//getSubProjects方法返回一个包含子project的set集合</span></span><br><span class="line">    <span class="keyword">this</span>.getSubprojects().each &#123; Project project -&gt;</span><br><span class="line">        println <span class="string">"child Project is $project"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/demoless/imgs/noteimage-20200426210204410.png" alt="image-20200426210204410"></p>
<h4 id="getParent"><a href="#getParent" class="headerlink" title="getParent"></a>getParent</h4><p><strong>获取当前 project 的父类，需要注意的是，如果我们在根工程中使用它，获取的父类会为 null，因为根工程没有父类</strong></p>
<p>在app模块下的build.gradle文件下：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.parent()</span><br><span class="line"><span class="keyword">def</span> parent() &#123;</span><br><span class="line">    println <span class="string">"&lt;==========================&gt;"</span></span><br><span class="line">    println <span class="string">"Parent Project is $&#123;this.getParent().toString()&#125;"</span></span><br><span class="line">    println <span class="string">"&lt;==========================&gt;"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/demoless/imgs/noteimage-20200426212655630.png" alt="image-20200426212655630"></p>
<h4 id="getRootProject"><a href="#getRootProject" class="headerlink" title="getRootProject"></a>getRootProject</h4><p><strong>getRootProject 即可在任意 build.gradle 文件获取当前根工程的 project 实例</strong></p>
<h4 id="project"><a href="#project" class="headerlink" title="project"></a>project</h4><p>project 表示的是 <strong>指定工程的实例，然后在闭包中对其进行操作</strong>。在使用之前，我们有必要看看 project 方法的源码:</p>
<p><img src="https://cdn.jsdelivr.net/gh/demoless/imgs/noteimage-20200426214655611.png" alt="image-20200426214655611"></p>
<p>project 方法中两个参数，<strong>一个是指定工程的路径，另一个是用来配置该工程的闭包</strong>,如何灵活使用project：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">project(<span class="string">"app"</span>) &#123; Project project -&gt;</span><br><span class="line">    apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//更简洁写法</span></span><br><span class="line">project(<span class="string">"app"</span>) &#123;</span><br><span class="line">    apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="subprojects"><a href="#subprojects" class="headerlink" title="subprojects"></a>subprojects</h4><p>subprojects 可以统一配置当前project下的所有子project：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">//为所有的aar文件设置配置脚本</span></span><br><span class="line">subprojects &#123;</span><br><span class="line">    <span class="keyword">if</span> (project.plugins.hasPlugin(<span class="string">"com.android.library"</span>)) &#123;</span><br><span class="line">        apply <span class="string">from:</span> <span class="string">'../publishToMaven.gradle'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="文件API"><a href="#文件API" class="headerlink" title="文件API"></a>文件API</h3><h4 id="路径获取API"><a href="#路径获取API" class="headerlink" title="路径获取API"></a>路径获取API</h4><ul>
<li>getRootDir()</li>
<li>getProjectDir()</li>
<li>getBuildDir()</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">println <span class="string">"the root file path is: $&#123;getRootDir().absolutePath&#125;"</span></span><br><span class="line">println <span class="string">"the build file path is: $&#123;getBuildDir().absolutePath&#125;"</span></span><br><span class="line">println <span class="string">"the project file path is:$&#123;getProjectDir().absolutePath&#125;"</span></span><br></pre></td></tr></table></figure>

<p>运行效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/demoless/imgs/noteimage-20200427185144866.png" alt="image-20200427185144866"></p>
<h2 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> startBuildTime,endBuildTime</span><br><span class="line"><span class="comment">//在Gradle配置阶段完成之后进行操作</span></span><br><span class="line"><span class="keyword">this</span>.afterEvaluate &#123; Project project -&gt;</span><br><span class="line">  	<span class="comment">//通过task名字从project的tasks中获取</span></span><br><span class="line">    <span class="keyword">def</span> preBuildTask = project.tasks.getByName(<span class="string">"preBuild"</span>)</span><br><span class="line">  	<span class="comment">//doFirst获取当前时间</span></span><br><span class="line">    preBuildTask.doFirst &#123;</span><br><span class="line">        <span class="comment">//获取第一个Task执行的时间</span></span><br><span class="line">        startBuildTime = System.currentTimeMillis()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">def</span> buildTask = project.tasks.getByName(<span class="string">"build"</span>)</span><br><span class="line">  	<span class="comment">//build最后记录当前时间</span></span><br><span class="line">    buildTask.doLast &#123;</span><br><span class="line">        endBuildTime = System.currentTimeMillis()</span><br><span class="line">    &#125;</span><br><span class="line">    println <span class="string">"Project build task execute time:$&#123;endBuildTime - startBuildTime&#125;"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Task依赖和执行顺序"><a href="#Task依赖和执行顺序" class="headerlink" title="Task依赖和执行顺序"></a>Task依赖和执行顺序</h3><p>Task的执行顺序有以下三种：</p>
<p><img src="https://cdn.jsdelivr.net/gh/demoless/imgs/notebe8fea3a-8d42-47b3-88c3-098e2372584b.png" alt="be8fea3a-8d42-47b3-88c3-098e2372584b"></p>
<h4 id="dependsOn-强依赖"><a href="#dependsOn-强依赖" class="headerlink" title="dependsOn 强依赖"></a>dependsOn 强依赖</h4><ul>
<li>静态依赖</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task task1 &#123;</span><br><span class="line">    doLast &#123;</span><br><span class="line">        println <span class="string">"this is task1"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">task task2 &#123;</span><br><span class="line">    doLast &#123;</span><br><span class="line">        println <span class="string">"this is task2"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//静态依赖常用方式</span></span><br><span class="line">task task3(<span class="string">dependsOn:</span>[task1,task2]) &#123;</span><br><span class="line">    doLast &#123;</span><br><span class="line">        println <span class="string">"this is task3"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//task静态依赖方式2</span></span><br><span class="line">task3.dependsOn(task1,task2)</span><br></pre></td></tr></table></figure>

<ul>
<li>动态依赖</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">//动态依赖方式</span></span><br><span class="line">task task4 &#123;</span><br><span class="line">    dependsOn <span class="keyword">this</span>.tasks.findAll &#123; task -&gt;</span><br><span class="line">        <span class="keyword">return</span> task.name.startsWith(<span class="string">"task"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    doLast &#123;</span><br><span class="line">        println <span class="string">"this is task4"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过-Task-指定输入输出"><a href="#通过-Task-指定输入输出" class="headerlink" title="通过 Task 指定输入输出"></a>通过 Task 指定输入输出</h3><p>通过 Task 来指定输入输出，使用这种方式我们可以 <strong>高效地实现一个 自动维护版本发布文档的 gradle 脚本</strong></p>
<h2 id="Gradle原理"><a href="#Gradle原理" class="headerlink" title="Gradle原理"></a>Gradle原理</h2><p>由gradle-wrapper到gradle的整个周期图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/demoless/imgs/notegradlew-gradlmain.png" alt="gradlew-gradlmain"></p>
<p><img src="https://cdn.jsdelivr.net/gh/demoless/imgs/noteb975a857-0508-465c-935c-b6a70f501300.png" alt="b975a857-0508-465c-935c-b6a70f501300"></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">zhf</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/04/09/Gradle学习笔记/">http://yoursite.com/2020/04/09/Gradle学习笔记/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android    </a><a class="post-meta__tags" href="/tags/Gradle/">Gradle    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/demoless/imgs/note下载.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2020/10/27/RecyclerView渲染流程/"><img class="prev_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span></span></div></a></div><div class="next-post pull-right"><a href="/2019/08/28/Android 事件分发源码解析/"><img class="next_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>Android 事件分发源码解析</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span>Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/07/30/浅谈Handler内部原理/" title="浅谈Handler内部原理"><img class="relatedPosts_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><div class="relatedPosts_title">浅谈Handler内部原理</div></a></div><div class="relatedPosts_item"><a href="/2019/07/30/深入理解Handler/" title="深入理解Handler"><img class="relatedPosts_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><div class="relatedPosts_title">深入理解Handler</div></a></div><div class="relatedPosts_item"><a href="/2019/08/28/Android 事件分发源码解析/" title="Android 事件分发源码解析"><img class="relatedPosts_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><div class="relatedPosts_title">Android 事件分发源码解析</div></a></div><div class="relatedPosts_item"><a href="/2019/08/18/Android View对象创建流程分析/" title="Android XML布局到View对象创建流程分析"><img class="relatedPosts_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><div class="relatedPosts_title">Android XML布局到View对象创建流程分析</div></a></div><div class="relatedPosts_item"><a href="/2019/08/08/浅谈Window视图绑定与工作原理/" title="浅谈Window视图绑定与工作原理"><img class="relatedPosts_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><div class="relatedPosts_title">浅谈Window视图绑定与工作原理</div></a></div><div class="relatedPosts_item"><a href="/2019/08/02/浅谈App启动流程/" title="浅谈App启动流程"><img class="relatedPosts_cover lozad" data-src="https://cdn.jsdelivr.net/gh/demoless/imgs/notestartActivity_jpg.jpg"><div class="relatedPosts_title">浅谈App启动流程</div></a></div></div><div class="clear_both"></div></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2020 By zhf</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="Read Mode"> </i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion">简</a><i class="fa fa-moon-o nightshift" id="nightshift" title="Dark Mode"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/nightshift.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zindex="-1" data-click="false"></script><script id="ribbon" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/js/piao.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script></body></html>